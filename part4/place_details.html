<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place Details</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        #place-details {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .place-header {
            position: relative;
            height: 300px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .place-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .place-price {
            font-size: 1.5rem;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .place-content {
            padding: 30px;
        }

        .place-description {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 30px;
            color: #555;
        }

        .amenities-section {
            margin-bottom: 30px;
        }

        .amenities-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .amenities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .amenity-item {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            font-weight: 500;
        }

        #reviews {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }

        .reviews-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .reviews-header h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .reviews-count {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .review-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
        }

        .review-author {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .review-text {
            color: #555;
            line-height: 1.6;
        }

        .review-date {
            font-size: 0.9rem;
            color: #888;
            margin-top: 10px;
        }

        .no-reviews {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }

        #add-review {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
            display: none;
        }

        #add-review h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        #review-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #review-form label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        #review-text {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        #review-text:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button[type="submit"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            align-self: flex-start;
        }

        button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        button[type="submit"]:active {
            transform: translateY(0);
        }

        .auth-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
            border: 1px solid #bee5eb;
        }

        @media (max-width: 768px) {
            main {
                padding: 10px;
            }

            .place-header h1 {
                font-size: 2rem;
            }

            .place-price {
                font-size: 1.2rem;
                padding: 8px 16px;
            }

            .place-content {
                padding: 20px;
            }

            .amenities-grid {
                grid-template-columns: 1fr;
            }

            #reviews, #add-review {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <main>
        <section id="place-details">
            <div class="loading">Loading place details...</div>
        </section>
        <section id="reviews">
            <div class="loading">Loading reviews...</div>
        </section>
        <section id="add-review">
            <h2>Add a Review</h2>
            <form id="review-form">
                <label for="review-text">Your Review:</label>
                <textarea id="review-text" name="review-text" placeholder="Share your experience about this place..." required></textarea>
                
                <button type="submit">Submit Review</button>
            </form>
        </section>
    </main>

    <script>
        // Global variables
        let authToken = null;
        let currentPlaceId = null;

        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            currentPlaceId = getPlaceIdFromURL();
            
            if (!currentPlaceId) {
                showError('place-details', 'No place ID specified in URL');
                return;
            }

            checkAuthentication();
            fetchPlaceDetails();
            setupReviewForm();
        });

        /**
         * Extract place ID from URL query parameters
         */
        function getPlaceIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id') || urlParams.get('placeId');
        }

        /**
         * Check if user is authenticated and show/hide review form accordingly
         */
        function checkAuthentication() {
            authToken = getCookie('token') || getCookie('authToken') || getCookie('jwt');
            const addReviewSection = document.getElementById('add-review');

            if (!authToken) {
                addReviewSection.style.display = 'none';
                // Show message about authentication
                const authMessage = document.createElement('div');
                authMessage.className = 'auth-message';
                authMessage.innerHTML = '<strong>Want to leave a review?</strong> Please log in to share your experience.';
                document.querySelector('main').appendChild(authMessage);
            } else {
                addReviewSection.style.display = 'block';
            }
        }

        /**
         * Get cookie value by name
         */
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                return parts.pop().split(';').shift();
            }
            return null;
        }

        /**
         * Fetch place details from API
         */
        async function fetchPlaceDetails() {
            try {
                const headers = {
                    'Content-Type': 'application/json'
                };

                // Include auth token if available
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch(`/api/places/${currentPlaceId}`, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const placeData = await response.json();
                displayPlaceDetails(placeData);
                displayReviews(placeData.reviews || []);

            } catch (error) {
                console.error('Error fetching place details:', error);
                showError('place-details', 'Failed to load place details. Please try again later.');
                showError('reviews', 'Failed to load reviews.');
            }
        }

        /**
         * Display place details in the UI
         */
        function displayPlaceDetails(place) {
            const placeDetailsSection = document.getElementById('place-details');
            
            // Clear loading message
            placeDetailsSection.innerHTML = '';

            // Create place details HTML
            const placeHTML = `
                <div class="place-header">
                    <div>
                        <h1>${escapeHtml(place.name || 'Unnamed Place')}</h1>
                        <div class="place-price">$${place.price || '0'}/night</div>
                    </div>
                </div>
                <div class="place-content">
                    <div class="place-description">
                        ${escapeHtml(place.description || 'No description available.')}
                    </div>
                    <div class="amenities-section">
                        <h3>Amenities</h3>
                        <div class="amenities-grid">
                            ${generateAmenitiesHTML(place.amenities)}
                        </div>
                    </div>
                </div>
            `;

            placeDetailsSection.innerHTML = placeHTML;

            // Update page title
            document.title = `${place.name || 'Place Details'} - Place Details`;
        }

        /**
         * Generate HTML for amenities
         */
        function generateAmenitiesHTML(amenities) {
            if (!amenities || amenities.length === 0) {
                return '<div class="amenity-item">No amenities listed</div>';
            }

            return amenities.map(amenity => 
                `<div class="amenity-item">${escapeHtml(amenity)}</div>`
            ).join('');
        }

        /**
         * Display reviews in the UI
         */
        function displayReviews(reviews) {
            const reviewsSection = document.getElementById('reviews');
            
            // Clear loading message
            reviewsSection.innerHTML = '';

            const reviewsHTML = `
                <div class="reviews-header">
                    <h2>Reviews</h2>
                    <div class="reviews-count">${reviews.length} review${reviews.length !== 1 ? 's' : ''}</div>
                </div>
                <div class="reviews-list">
                    ${reviews.length > 0 ? generateReviewsHTML(reviews) : '<div class="no-reviews">No reviews yet. Be the first to leave a review!</div>'}
                </div>
            `;

            reviewsSection.innerHTML = reviewsHTML;
        }

        /**
         * Generate HTML for reviews
         */
        function generateReviewsHTML(reviews) {
            return reviews.map(review => `
                <div class="review-item">
                    <div class="review-author">${escapeHtml(review.author || review.user || 'Anonymous')}</div>
                    <div class="review-text">${escapeHtml(review.text || review.content || '')}</div>
                    <div class="review-date">${formatDate(review.date || review.created_at)}</div>
                </div>
            `).join('');
        }

        /**
         * Setup review form submission
         */
        function setupReviewForm() {
            const reviewForm = document.getElementById('review-form');
            
            reviewForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!authToken) {
                    alert('Please log in to submit a review.');
                    return;
                }

                const reviewText = document.getElementById('review-text').value.trim();
                
                if (!reviewText) {
                    alert('Please enter a review before submitting.');
                    return;
                }

                await submitReview(reviewText);
            });
        }

        /**
         * Submit review to API
         */
        async function submitReview(reviewText) {
            const submitButton = document.querySelector('#review-form button[type="submit"]');
            const originalText = submitButton.textContent;
            
            try {
                // Show loading state
                submitButton.textContent = 'Submitting...';
                submitButton.disabled = true;

                const response = await fetch(`/api/places/${currentPlaceId}/reviews`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        text: reviewText,
                        rating: 5 // You can add a rating input field if needed
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                // Clear the form
                document.getElementById('review-text').value = '';
                
                // Show success message
                showSuccessMessage('Review submitted successfully!');
                
                // Refresh the reviews
                setTimeout(() => {
                    fetchPlaceDetails();
                }, 1000);

            } catch (error) {
                console.error('Error submitting review:', error);
                alert('Failed to submit review. Please try again.');
            } finally {
                // Reset button state
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        }

        /**
         * Show error message in a section
         */
        function showError(sectionId, message) {
            const section = document.getElementById(sectionId);
            section.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
        }

        /**
         * Show success message
         */
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #d4edda;
                color: #155724;
                padding: 15px 20px;
                border-radius: 8px;
                border: 1px solid #c3e6cb;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 1000;
                font-weight: bold;
            `;
            successDiv.textContent = message;
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        /**
         * Format date for display
         */
        function formatDate(dateString) {
            if (!dateString) return 'Date not available';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return 'Date not available';
            }
        }


    </script>
</body>
</html>
